<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Lincity-ng-commit] r1582 - trunk/src/lincity-ng
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/lincity-ng-commit/2010-June/index.html" >
   <LINK REL="made" HREF="mailto:lincity-ng-commit%40lists.berlios.de?Subject=Re%3A%20%5BLincity-ng-commit%5D%20r1582%20-%20trunk/src/lincity-ng&In-Reply-To=%3C201006241250.o5OCoZHS021971%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000515.html">
   <LINK REL="Next"  HREF="000517.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Lincity-ng-commit] r1582 - trunk/src/lincity-ng</H1>
    <B>alainb at BerliOS</B> 
    <A HREF="mailto:lincity-ng-commit%40lists.berlios.de?Subject=Re%3A%20%5BLincity-ng-commit%5D%20r1582%20-%20trunk/src/lincity-ng&In-Reply-To=%3C201006241250.o5OCoZHS021971%40sheep.berlios.de%3E"
       TITLE="[Lincity-ng-commit] r1582 - trunk/src/lincity-ng">alainb at mail.berlios.de
       </A><BR>
    <I>Thu Jun 24 14:50:35 CEST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="000515.html">[Lincity-ng-commit] r1581 - trunk/data/opening
</A></li>
        <LI>Next message: <A HREF="000517.html">[Lincity-ng-commit] r1583 - trunk/src/gui
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#516">[ date ]</a>
              <a href="thread.html#516">[ thread ]</a>
              <a href="subject.html#516">[ subject ]</a>
              <a href="author.html#516">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: alainb
Date: 2010-06-24 14:50:35 +0200 (Thu, 24 Jun 2010)
New Revision: 1582

Modified:
   trunk/src/lincity-ng/EconomyGraph.cpp
Log:
log scale (or percentage) for economy graph

Modified: trunk/src/lincity-ng/EconomyGraph.cpp
===================================================================
--- trunk/src/lincity-ng/EconomyGraph.cpp	2010-06-24 12:50:33 UTC (rev 1581)
+++ trunk/src/lincity-ng/EconomyGraph.cpp	2010-06-24 12:50:35 UTC (rev 1582)
@@ -73,14 +73,14 @@
 EconomyGraph::~EconomyGraph(){
     if( economyGraphPtr == this ){
         economyGraphPtr = 0;
-    } 
+    }
     free( fps );
-    delete labelTextureMIN; 
-    delete labelTexturePRT; 
-    delete labelTextureMNY; 
-    delete labelTexturePOP; 
-    delete labelTextureTEC; 
-    delete labelTextureFIR; 
+    delete labelTextureMIN;
+    delete labelTexturePRT;
+    delete labelTextureMNY;
+    delete labelTexturePOP;
+    delete labelTextureTEC;
+    delete labelTextureFIR;
     delete labelTextureEconomy;
     delete labelTextureSustainability;
     delete labelTextureFPS;
@@ -107,7 +107,7 @@
                 throw std::runtime_error(msg.str());
             }
         } else {
-            std::cerr &lt;&lt; &quot;Unknown attribute '&quot; &lt;&lt; name 
+            std::cerr &lt;&lt; &quot;Unknown attribute '&quot; &lt;&lt; name
                       &lt;&lt; &quot;' skipped in EconomyGraph.\n&quot;;
         }
     }
@@ -124,24 +124,24 @@
     labelXXX = TTF_RenderUTF8_Blended( font, _(&quot;Mining&quot;), labelStyle.text_color.getSDLColor() );
     labelTextureMIN = texture_manager-&gt;create( labelXXX );
     labelXXX = TTF_RenderUTF8_Blended( font, _(&quot;Trade&quot;), labelStyle.text_color.getSDLColor() );
-    labelTexturePRT = texture_manager-&gt;create( labelXXX ); 
+    labelTexturePRT = texture_manager-&gt;create( labelXXX );
     labelXXX = TTF_RenderUTF8_Blended( font, _(&quot;Money&quot;), labelStyle.text_color.getSDLColor() );
-    labelTextureMNY = texture_manager-&gt;create( labelXXX ); 
+    labelTextureMNY = texture_manager-&gt;create( labelXXX );
     labelXXX = TTF_RenderUTF8_Blended( font, _(&quot;Popul.&quot;), labelStyle.text_color.getSDLColor() );
-    labelTexturePOP = texture_manager-&gt;create( labelXXX ); 
+    labelTexturePOP = texture_manager-&gt;create( labelXXX );
     labelXXX = TTF_RenderUTF8_Blended( font, _(&quot;Techn.&quot;), labelStyle.text_color.getSDLColor() );
-    labelTextureTEC = texture_manager-&gt;create( labelXXX ); 
+    labelTextureTEC = texture_manager-&gt;create( labelXXX );
     labelXXX = TTF_RenderUTF8_Blended( font, _(&quot;Fire&quot;), labelStyle.text_color.getSDLColor() );
-    labelTextureFIR = texture_manager-&gt;create( labelXXX ); 
+    labelTextureFIR = texture_manager-&gt;create( labelXXX );
 
     labelXXX = TTF_RenderUTF8_Blended( font, _(&quot;Economy Overview:&quot;), labelStyle.text_color.getSDLColor() );
-    labelTextureEconomy = texture_manager-&gt;create( labelXXX ); 
-    
+    labelTextureEconomy = texture_manager-&gt;create( labelXXX );
+
     labelXXX = TTF_RenderUTF8_Blended( font, _(&quot;Sustainability:&quot;), labelStyle.text_color.getSDLColor() );
-    labelTextureSustainability = texture_manager-&gt;create( labelXXX ); 
+    labelTextureSustainability = texture_manager-&gt;create( labelXXX );
 
     labelXXX = TTF_RenderUTF8_Blended( font, _(&quot;Frames per Second:&quot;), labelStyle.text_color.getSDLColor() );
-    labelTextureFPS = texture_manager-&gt;create( labelXXX ); 
+    labelTextureFPS = texture_manager-&gt;create( labelXXX );
 }
 
 //see do_history_linegraph in oldgui/screen.cpp
@@ -150,7 +150,7 @@
     float f;
     int w = getConfig()-&gt;monthgraphW;
     //thats the value oldgui uses, so saved data has same scale as new.
-    int h = 64; //MONTHGRAPH_H; 
+    int h = 64; //MONTHGRAPH_H;
 
     for (i = w - 1; i &gt; 0; i--) {
 	    monthgraph_pop[i] = monthgraph_pop[i-1];
@@ -158,39 +158,38 @@
 	    monthgraph_nojobs[i] = monthgraph_nojobs[i-1];
 	    monthgraph_starve[i] = monthgraph_starve[i-1];
     }
-    if (tpopulation &gt; 0)
-    {
-	monthgraph_pop[0] = ((int) (log ((tpopulation / NUMOF_DAYS_IN_MONTH)
-					 + 1.f) * h / 15)) - 5;
-	if (monthgraph_pop[0] &lt; 0)
-	    monthgraph_pop[0] = 0;
-	f = ((float) tstarving_population 
-	     / ((float) tpopulation + 1.0)) * 100.0;
-	if (tpopulation &gt; 3000)	/* double the scale if pop &gt; 3000 */
-	    f += f;
-	if (tpopulation &gt; 6000)	/* double it AGAIN if pop &gt; 6000 */
-	    f += f;
-	monthgraph_starve[0] = (int) f;
-	/* max out at 32 */
-	if (monthgraph_starve[0] &gt;= h)
-	    monthgraph_starve[0] = h - 1;
-	f = ((float) tunemployed_population
-	     / ((float) tpopulation + 1.0)) * 100.0;
-	if (tpopulation &gt; 3000)	/* double the scale if pop &gt; 3000 */
-	    f += f;
-	if (tpopulation &gt; 6000)	/* double it AGAIN if pop &gt; 6000 */
-	    f += f;
-	monthgraph_nojobs[0] = (int) f;
-	/* max out at 32  */
-	if (monthgraph_nojobs[0] &gt;= h)
-	    monthgraph_nojobs[0] = h - 1;
-	monthgraph_ppool[0] = ((int) (sqrt (people_pool + 1.f) * h) / 35);
-	if (monthgraph_ppool[0] &lt; 0)
-	    monthgraph_ppool[0] = 0;
-	if (monthgraph_ppool[0] &gt;= h)
-	    monthgraph_ppool[0] = h - 1;
+    if (tpopulation &gt; 0) {
+        /* log scale 0 -&gt; 200 000 = 10^5.3 */
+        float scale = h / (5.3 * log(10.));
+        float t = (total_time %NUMOF_DAYS_IN_MONTH + 1.f);
+
+        monthgraph_pop[0] = (int) (log (tpopulation / t) * scale);
+        if (monthgraph_pop[0] &lt; 0)
+            monthgraph_pop[0] = 0;
+        if (monthgraph_pop[0] &gt;= h)
+            monthgraph_pop[0] = h - 1;
+
+        monthgraph_starve[0] = (int) (log( tstarving_population  /  t) * scale);
+        if (monthgraph_starve[0] &lt; 0)
+            monthgraph_starve[0] = 0;
+        if (monthgraph_starve[0] &gt;= h)
+            monthgraph_starve[0] = h - 1;
+
+        monthgraph_nojobs[0] = (int) (log( tunemployed_population  / t) * scale);
+        if (monthgraph_nojobs[0] &lt; 0)
+            monthgraph_nojobs[0] = 0;
+        if (monthgraph_nojobs[0] &gt;= h)
+            monthgraph_nojobs[0] = h - 1;
+
+        /* percentage scale */
+        f = (float) people_pool / (float) (tpopulation / t + people_pool) * (float) h;
+        monthgraph_ppool[0] = (int) f;
+        if (monthgraph_ppool[0] &lt; 0)
+            monthgraph_ppool[0] = 0;
+        if (monthgraph_ppool[0] &gt;= h)
+            monthgraph_ppool[0] = h - 1;
     }
-    
+
     //sustainability check from do_sust_barchart
     if (sust_dig_ore_coal_count &gt;= SUST_ORE_COAL_YEARS_NEEDED
         &amp;&amp; sust_port_count &gt;= SUST_PORT_YEARS_NEEDED
@@ -207,7 +206,7 @@
         sustain_flag = 0;
     }
 
-    
+
     //sustain_flag == 1 means player had a sustainable economy
     //total_evacuated &gt;0 means player evacuated at least some people
     if( !housed_population &amp;&amp; !people_pool ){ //no people left
@@ -231,8 +230,8 @@
     } else if( nobodyHomeDialogShown ){ //reset flag if there are people
         nobodyHomeDialogShown = false;
     }
-   
 
+
     Component* root = this;
     while( root-&gt;getParent() ){
         root = root-&gt;getParent();
@@ -247,7 +246,7 @@
         yellowStyle.text_color.parse(&quot;yellow&quot;);
         redStyle.text_color.parse(&quot;red&quot;);
     }
- 
+
     // set tab Button colour
     if( switchEconomyGraphParagraph ){
         if( monthgraph_starve[0] &gt; 0 ){ // people are starving: RED
@@ -258,7 +257,7 @@
             switchEconomyGraphParagraph-&gt;setText(switchEconomyGraphText, normalStyle);
         }
     }
-    
+
     //redraw
     setDirty();
 }
@@ -274,8 +273,8 @@
     setDirty();
 }
 
-void EconomyGraph::drawHistoryLineGraph( Painter&amp; painter, Rect2D mg ){ 
-    // see oldgui/screen.cpp do_history_linegraph 
+void EconomyGraph::drawHistoryLineGraph( Painter&amp; painter, Rect2D mg ){
+    // see oldgui/screen.cpp do_history_linegraph
     Vector2 a;
     Vector2 b;
 
@@ -286,28 +285,28 @@
     brown.parse( &quot;brown&quot; );
     grey.parse(&quot;#A9A9A9FF&quot;);
 
-    painter.setClipRectangle( mg ); 
+    painter.setClipRectangle( mg );
     painter.setFillColor( grey );
     painter.fillRectangle( mg );
     int mgX = (int) mg.p1.x;
     int mgY = (int) mg.p1.y;
-    int mgW = (int) mg.getWidth(); 
+    int mgW = (int) mg.getWidth();
     int mgH = (int) mg.getHeight();
-    
+
     float scale = (float) mgH / 64; //MONTHGRAPH_H  ;
-    
+
     b.y = mgY + mgH;
     for( int i = mgW - 1; i &gt;= 0; i-- ){
         painter.setLineColor( yellow );
         a.x = mgX + mgW - i;
         a.y = mgY + mgH - scale * monthgraph_nojobs[i];
-        
+
         b.x = mgX + mgW - i;
         painter.drawLine( a, b );
         painter.setLineColor( red );
         a.y = mgY + mgH - scale * monthgraph_starve[i];
         painter.drawLine( a, b );
-    }                  
+    }
     for( int i = mgW - 1; i &gt; 0; i-- ){
         painter.setLineColor( brown );
         a.x = mgX + mgW - i;
@@ -325,7 +324,7 @@
 
 }
 
-void EconomyGraph::drawSustBarGraph( Painter&amp; painter, Rect2D mg ){ 
+void EconomyGraph::drawSustBarGraph( Painter&amp; painter, Rect2D mg ){
     // see oldgui/screen.cpp do_sust_barchart
     Color grey,yellow,orange,black,green,blue,red;
     grey.parse( &quot;#A9A9A9FF&quot; );
@@ -338,14 +337,14 @@
 
     painter.setFillColor( grey );
     painter.fillRectangle( mg );
-  
+
     int mgX = (int) mg.p1.x;
     int mgY = (int) mg.p1.y;
-    int mgW = (int) mg.getWidth(); 
+    int mgW = (int) mg.getWidth();
     int mgH = (int) mg.getHeight();
 
     Vector2 a, b, p;
-    
+
 #define SUST_BAR_H      5
 #define SUST_BAR_GAP_Y  5
 
@@ -358,23 +357,23 @@
     p.y = mgY;
     painter.setLineColor( yellow );
     painter.drawLine( a, b);
-    
+
     Rect2D bar;
     bar.p1.x = mgX + 36;
     bar.p1.y = mgY + SUST_BAR_GAP_Y;
     bar.setHeight( SUST_BAR_H );
     int maxBarLen = mgW - 40;
     int newLen;
-    int len; 
-    
+    int len;
+
 	/* ore coal */
     newLen = maxBarLen * sust_dig_ore_coal_count / SUST_ORE_COAL_YEARS_NEEDED;
     len = 3 + ( ( newLen &gt; maxBarLen ) ? maxBarLen : newLen );
     bar.setWidth( len );
     painter.setFillColor( orange );
     painter.fillRectangle( bar );
-    painter.drawTexture( labelTextureMIN, p ); 
-    
+    painter.drawTexture( labelTextureMIN, p );
+
 	/* import export */
     p.y += SUST_BAR_H + SUST_BAR_GAP_Y ;
     newLen = maxBarLen * sust_port_count / SUST_PORT_YEARS_NEEDED;
@@ -383,8 +382,8 @@
     painter.setFillColor( black );
     bar.move( Vector2( 0, SUST_BAR_H + SUST_BAR_GAP_Y ) );
     painter.fillRectangle( bar );
-    painter.drawTexture( labelTexturePRT, p ); 
-    
+    painter.drawTexture( labelTexturePRT, p );
+
 	/* money */
     p.y += SUST_BAR_H + SUST_BAR_GAP_Y ;
     newLen = maxBarLen * sust_old_money_count / SUST_MONEY_YEARS_NEEDED;
@@ -393,8 +392,8 @@
     painter.setFillColor( green );
     bar.move( Vector2( 0, SUST_BAR_H + SUST_BAR_GAP_Y ) );
     painter.fillRectangle( bar );
-    painter.drawTexture( labelTextureMNY, p ); 
-    
+    painter.drawTexture( labelTextureMNY, p );
+
 	/* population */
     p.y += SUST_BAR_H + SUST_BAR_GAP_Y ;
     newLen = maxBarLen * sust_old_population_count / SUST_POP_YEARS_NEEDED;
@@ -403,8 +402,8 @@
     painter.setFillColor( blue );
     bar.move( Vector2( 0, SUST_BAR_H + SUST_BAR_GAP_Y ) );
     painter.fillRectangle( bar );
-    painter.drawTexture( labelTexturePOP, p ); 
-    
+    painter.drawTexture( labelTexturePOP, p );
+
 	/* tech */
     p.y += SUST_BAR_H + SUST_BAR_GAP_Y ;
     newLen = maxBarLen * sust_old_tech_count / SUST_TECH_YEARS_NEEDED;
@@ -413,8 +412,8 @@
     painter.setFillColor( yellow );
     bar.move( Vector2( 0, SUST_BAR_H + SUST_BAR_GAP_Y ) );
     painter.fillRectangle( bar );
-    painter.drawTexture( labelTextureTEC, p ); 
-    
+    painter.drawTexture( labelTextureTEC, p );
+
 	/* fire */
     p.y += SUST_BAR_H + SUST_BAR_GAP_Y ;
     newLen = maxBarLen * sust_fire_count / SUST_FIRE_YEARS_NEEDED;
@@ -423,72 +422,72 @@
     painter.setFillColor( red );
     bar.move( Vector2( 0, SUST_BAR_H + SUST_BAR_GAP_Y ) );
     painter.fillRectangle( bar );
-    painter.drawTexture( labelTextureFIR, p ); 
+    painter.drawTexture( labelTextureFIR, p );
 }
 
 
-void EconomyGraph::drawFPSGraph( Painter&amp; painter, Rect2D fpsRect ){ 
+void EconomyGraph::drawFPSGraph( Painter&amp; painter, Rect2D fpsRect ){
     Color grey, blue;
     blue.parse( &quot;blue&quot; );
     grey.parse(&quot;#A9A9A9FF&quot;);
     int mgX = (int) fpsRect.p1.x;
     int mgY = (int) fpsRect.p1.y;
-    int mgW = (int) fpsRect.getWidth(); 
+    int mgW = (int) fpsRect.getWidth();
     int mgH = (int) fpsRect.getHeight();
 
-    
+
     painter.setFillColor( grey );
     painter.fillRectangle( fpsRect );
-    
-    painter.setClipRectangle( fpsRect ); 
-      
+
+    painter.setClipRectangle( fpsRect );
+
     Vector2 a;
     Vector2 b;
     painter.setLineColor( blue );
-    
+
     float scale = (float) mgH / 64; //MONTHGRAPH_H  ;
 
     b.y = mgY + mgH;
     for( int i = mgW - 1; i &gt;= 0; i-- ){
         a.x = mgX + mgW - i;
         a.y = mgY + mgH - scale * fps[i];
-        
+
         b.x = mgX + mgW - i;
         painter.drawLine( a, b );
     }
     painter.clearClipRectangle();
 }
-    
+
 void EconomyGraph::draw( Painter&amp; painter ){
-   
+
     Color white;
     white.parse( &quot;white&quot; );
-    
+
     Rect2D background( 0, 0, getWidth(), getHeight() );
     int mgX = border;
     int mgY = 3*border;
-    int mgW = getConfig()-&gt;monthgraphW; 
+    int mgW = getConfig()-&gt;monthgraphW;
     int mgH = getConfig()-&gt;monthgraphH;
-    
+
     painter.setFillColor( white );
     painter.fillRectangle( background );
 
     Vector2 labelPos( 2 * border, border-1 );
-    
+
     //Draw HistoryLineGraph
-    painter.drawTexture( labelTextureEconomy, labelPos ); 
+    painter.drawTexture( labelTextureEconomy, labelPos );
     Rect2D currentGraph( mgX, mgY, mgX + mgW, mgY + mgH );
     drawHistoryLineGraph( painter, currentGraph );
 
     //Draw Sustainability Bars
-    labelPos.y += 2 * border + mgH; 
-    painter.drawTexture( labelTextureSustainability, labelPos ); 
+    labelPos.y += 2 * border + mgH;
+    painter.drawTexture( labelTextureSustainability, labelPos );
     currentGraph.move( Vector2( 0, 2 * border + mgH ) );
     drawSustBarGraph( painter, currentGraph);
 
     //Draw FPS-Window
-    labelPos.y += 2 * border + mgH; 
-    painter.drawTexture( labelTextureFPS, labelPos ); 
+    labelPos.y += 2 * border + mgH;
+    painter.drawTexture( labelTextureFPS, labelPos );
     currentGraph.move( Vector2( 0, 2 * border + mgH ) );
     currentGraph.setHeight( mgH/2 );
     drawFPSGraph( painter, currentGraph );


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000515.html">[Lincity-ng-commit] r1581 - trunk/data/opening
</A></li>
	<LI>Next message: <A HREF="000517.html">[Lincity-ng-commit] r1583 - trunk/src/gui
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#516">[ date ]</a>
              <a href="thread.html#516">[ thread ]</a>
              <a href="subject.html#516">[ subject ]</a>
              <a href="author.html#516">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/lincity-ng-commit">More information about the Lincity-ng-commit
mailing list</a><br>
</body></html>
